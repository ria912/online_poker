<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Poker - Test Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .section h2 {
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input, button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }

        input {
            flex: 1;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.9);
        }

        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .action-btn {
            background: #2196F3;
        }

        .action-btn:hover:not(:disabled) {
            background: #0b7dda;
        }

        .fold-btn {
            background: #f44336;
        }

        .fold-btn:hover:not(:disabled) {
            background: #da190b;
        }

        #log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #4CAF50;
            padding-left: 10px;
        }

        .log-error {
            border-left-color: #f44336;
            color: #ff6b6b;
        }

        .log-success {
            border-left-color: #4CAF50;
            color: #69f0ae;
        }

        .log-info {
            border-left-color: #2196F3;
            color: #64b5f6;
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status.connected {
            background: #4CAF50;
        }

        .status.disconnected {
            background: #f44336;
        }

        .game-state {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }

        .game-state h3 {
            margin-bottom: 10px;
            color: #FFD700;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
        }

        .info-label {
            color: #aaa;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: bold;
        }

        .seats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .seat {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            border: 2px solid transparent;
        }

        .seat.active {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .seat.current {
            background: rgba(255, 215, 0, 0.2);
        }

        .seat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .player-name {
            font-weight: bold;
            font-size: 16px;
        }

        .player-stack {
            color: #4CAF50;
            font-weight: bold;
        }

        .cards {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .card {
            background: white;
            color: black;
            padding: 5px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }

        .card.hidden {
            background: #333;
            color: #333;
        }

        .community-cards {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .community-cards .card {
            font-size: 20px;
            padding: 10px 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ Online Poker Test Client</h1>

        <!-- „Ç≤„Éº„É†‰ΩúÊàê -->
        <div class="section">
            <h2>1. „Ç≤„Éº„É†‰ΩúÊàê</h2>
            <div class="controls">
                <input type="number" id="bigBlind" value="100" placeholder="Big Blind" min="10">
                <input type="number" id="buyIn" value="10000" placeholder="Buy In" min="1000">
                <button onclick="createGame()">„Ç≤„Éº„É†‰ΩúÊàê</button>
            </div>
            <div id="gameIdDisplay"></div>
        </div>

        <!-- WebSocketÊé•Á∂ö -->
        <div class="section">
            <h2>2. WebSocketÊé•Á∂ö <span class="status disconnected" id="wsStatus">Êú™Êé•Á∂ö</span></h2>
            <div class="controls">
                <input type="text" id="gameId" placeholder="Game ID">
                <input type="text" id="username" value="Player1" placeholder="Username">
                <button onclick="connectWebSocket()">Êé•Á∂ö</button>
                <button onclick="disconnectWebSocket()">ÂàáÊñ≠</button>
            </div>
        </div>

        <!-- „Ç≤„Éº„É†Êìç‰Ωú -->
        <div class="section">
            <h2>3. „Ç≤„Éº„É†Êìç‰Ωú</h2>
            <div class="controls">
                <button onclick="startGame()" id="startBtn">„Ç≤„Éº„É†ÈñãÂßã</button>
                <button onclick="getState()">Áä∂ÊÖãÂèñÂæó</button>
            </div>
            <div class="controls">
                <button class="action-btn" onclick="playerAction('CHECK')" id="checkBtn">Check</button>
                <button class="action-btn" onclick="playerAction('CALL')" id="callBtn">Call</button>
                <button class="fold-btn" onclick="playerAction('FOLD')" id="foldBtn">Fold</button>
                <input type="number" id="betAmount" placeholder="„Éô„ÉÉ„ÉàÈ°ç" value="200" min="0">
                <button class="action-btn" onclick="playerAction('BET')" id="betBtn">Bet</button>
                <button class="action-btn" onclick="playerAction('RAISE')" id="raiseBtn">Raise</button>
            </div>
        </div>

        <!-- „Ç≤„Éº„É†Áä∂ÊÖãË°®Á§∫ -->
        <div class="section">
            <h2>4. „Ç≤„Éº„É†Áä∂ÊÖã</h2>
            <div class="game-state" id="gameState">
                <p style="color: #aaa;">„Ç≤„Éº„É†„Å´Êé•Á∂ö„Åô„Çã„Å®Áä∂ÊÖã„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
            </div>
        </div>

        <!-- „É≠„Ç∞ -->
        <div class="section">
            <h2>5. „É≠„Ç∞</h2>
            <button onclick="clearLog()" style="margin-bottom: 10px;">„É≠„Ç∞„ÇØ„É™„Ç¢</button>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentGameId = null;
        let currentGameState = null;

        // „É≠„Ç∞Âá∫Âäõ
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // „Ç≤„Éº„É†‰ΩúÊàê
        async function createGame() {
            const bigBlind = parseInt(document.getElementById('bigBlind').value);
            const buyIn = parseInt(document.getElementById('buyIn').value);

            try {
                log('„Ç≤„Éº„É†‰ΩúÊàê‰∏≠...', 'info');
                const response = await fetch('/api/games/single-play', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ big_blind: bigBlind, buy_in: buyIn })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentGameId = data.game_id;
                    document.getElementById('gameId').value = currentGameId;
                    document.getElementById('gameIdDisplay').innerHTML = 
                        `<strong>Game ID:</strong> ${currentGameId}<br>` +
                        `<strong>AI Players:</strong> ${data.ai_players.join(', ')}`;
                    log(`„Ç≤„Éº„É†‰ΩúÊàêÊàêÂäü: ${currentGameId}`, 'success');
                    log(`AI: ${data.ai_players.join(', ')}`, 'info');
                } else {
                    log(`„Ç®„É©„Éº: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // WebSocketÊé•Á∂ö
        function connectWebSocket() {
            const gameId = document.getElementById('gameId').value;
            const username = document.getElementById('username').value;

            if (!gameId || !username) {
                log('Game ID„Å®Username„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const wsUrl = `ws://${window.location.host}/ws/game/${gameId}?username=${username}`;
            log(`Êé•Á∂ö‰∏≠: ${wsUrl}`, 'info');

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                log('WebSocketÊé•Á∂öÊàêÂäü', 'success');
                document.getElementById('wsStatus').textContent = 'Êé•Á∂ö‰∏≠';
                document.getElementById('wsStatus').className = 'status connected';
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                log(`Âèó‰ø°: ${message.type}`, 'info');
                
                if (message.type === 'game_state') {
                    currentGameState = message.data;
                    displayGameState(message.data);
                } else if (message.type === 'error') {
                    log(`„Ç®„É©„Éº: ${message.error}`, 'error');
                } else {
                    log(`„É°„ÉÉ„Çª„Éº„Ç∏: ${JSON.stringify(message)}`, 'info');
                }
            };

            ws.onerror = (error) => {
                log('WebSocket„Ç®„É©„Éº', 'error');
                console.error(error);
            };

            ws.onclose = () => {
                log('WebSocketÂàáÊñ≠', 'info');
                document.getElementById('wsStatus').textContent = 'ÂàáÊñ≠';
                document.getElementById('wsStatus').className = 'status disconnected';
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            ws.send(JSON.stringify({ type: 'start_game' }));
            log('„Ç≤„Éº„É†ÈñãÂßã„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°', 'info');
        }

        // Áä∂ÊÖãÂèñÂæó
        function getState() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            ws.send(JSON.stringify({ type: 'get_state' }));
            log('Áä∂ÊÖãÂèñÂæó„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°', 'info');
        }

        // „Éó„É¨„Ç§„É§„Éº„Ç¢„ÇØ„Ç∑„Éß„É≥
        function playerAction(action) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            let amount = 0;
            if (action === 'BET' || action === 'RAISE') {
                amount = parseInt(document.getElementById('betAmount').value) || 0;
            }

            ws.send(JSON.stringify({
                type: 'player_action',
                action: action,
                amount: amount
            }));

            log(`„Ç¢„ÇØ„Ç∑„Éß„É≥ÈÄÅ‰ø°: ${action} (${amount})`, 'info');
        }

        // „Ç≤„Éº„É†Áä∂ÊÖãË°®Á§∫
        function displayGameState(state) {
            const container = document.getElementById('gameState');
            
            let html = `
                <div class="game-info">
                    <div class="info-item">
                        <div class="info-label">„Çπ„ÉÜ„Éº„Çø„Çπ</div>
                        <div class="info-value">${state.status}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">„É©„Ç¶„É≥„Éâ</div>
                        <div class="info-value">${state.current_round}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ÁèæÂú®„ÅÆ„Éô„ÉÉ„Éà</div>
                        <div class="info-value">üí∞ ${state.current_bet}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">„Éù„ÉÉ„Éà</div>
                        <div class="info-value">üí∞ ${state.pots.reduce((sum, p) => sum + p.amount, 0)}</div>
                    </div>
                </div>
            `;

            // „Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Ç´„Éº„Éâ
            if (state.community_cards && state.community_cards.length > 0) {
                html += '<h3>üÉè „Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Ç´„Éº„Éâ</h3>';
                html += '<div class="community-cards">';
                state.community_cards.forEach(card => {
                    html += `<div class="card">${card.rank}${card.suit}</div>`;
                });
                html += '</div>';
            }

            // Â∫ßÂ∏≠ÊÉÖÂ†±
            html += '<h3>üë• Â∫ßÂ∏≠</h3>';
            html += '<div class="seats">';
            state.seats.forEach((seat, index) => {
                if (seat.player) {
                    const isCurrent = index === state.current_seat_index;
                    const isActive = seat.status === 'ACTIVE';
                    html += `
                        <div class="seat ${isCurrent ? 'current' : ''} ${isActive ? 'active' : ''}">
                            <div class="seat-header">
                                <span class="player-name">
                                    ${seat.player.name} ${seat.player.is_ai ? 'ü§ñ' : 'üë§'}
                                    ${isCurrent ? '‚≠ê' : ''}
                                </span>
                                <span class="player-stack">üí∞ ${seat.stack}</span>
                            </div>
                            <div>„Éô„ÉÉ„Éà: ${seat.bet_in_round} | „Çπ„ÉÜ„Éº„Çø„Çπ: ${seat.status}</div>
                            ${seat.last_action ? `<div>ÂâçÂõû: ${seat.last_action}</div>` : ''}
                            ${seat.hole_cards && seat.hole_cards.length > 0 ? `
                                <div class="cards">
                                    ${seat.hole_cards.map(card => 
                                        `<div class="card">${card.rank}${card.suit}</div>`
                                    ).join('')}
                                </div>
                            ` : '<div class="cards"><div class="card hidden">?</div><div class="card hidden">?</div></div>'}
                        </div>
                    `;
                }
            });
            html += '</div>';

            // ÂãùËÄÖÊÉÖÂ†±
            if (state.winners && state.winners.length > 0) {
                html += '<h3>üèÜ ÂãùËÄÖ</h3>';
                state.winners.forEach(winner => {
                    html += `<div class="info-item">
                        <strong>${winner.player_name}</strong> - 
                        ${winner.hand_name} - 
                        üí∞ ${winner.amount}
                    </div>`;
                });
            }

            container.innerHTML = html;
        }

        // ÂàùÊúü„É≠„Ç∞
        log('„ÉÜ„Çπ„Éà„ÇØ„É©„Ç§„Ç¢„É≥„ÉàËµ∑Âãï', 'success');
        log('1. „Ç≤„Éº„É†„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
        log('2. WebSocket„Å´Êé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
        log('3. „Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
    </script>
</body>
</html>
